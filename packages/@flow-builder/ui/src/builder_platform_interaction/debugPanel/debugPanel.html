<template>
    <div class="slds-panel__header" tabindex="-1">
        <h2 if:false={showTestAssertions} class="slds-panel__header-title slds-text-heading_small slds-truncate">
            {labels.debugInspector}
        </h2>
        <h2 if:true={showTestAssertions} class="slds-panel__header-title slds-text-heading_small slds-truncate">
            {labels.testInspector}
        </h2>
    </div>
    <!-- filter gear icon and selected filters text-->
    <div class="slds-grid slds-border_bottom" if:false={showTestAssertions}>
        <div class="slds-m-left_small slds-m-vertical_x-small">
            <lightning-button
                variant="Neutral"
                label={expandLabelVar}
                title={expandTitleVar}
                onclick={handleExpandAll}
                class="slds-m-left_x-medium test-expand-button"
            >
            </lightning-button>
        </div>
        <div class="slds-m-left_xxx-small slds-m-vertical_xx-small">
            <builder_platform_interaction-debug-panel-filter
                onpanelfilter={handleDropdown}
                selections={selectedOptions}
            >
            </builder_platform_interaction-debug-panel-filter>
            <!-- popover containing checkboxes for filters -->
            <template if:true={showOptions}>
                <section
                    aria-label={labels.filterPopoverAltText}
                    aria-describedby="popover-body-id"
                    class="slds-popover slds-is-absolute slds-nubbin_top-left slds-m-left_xx-small"
                    role="popover"
                >
                    <div id="popover-body-id" class="slds-popover__body">
                        <!--- close popover icon -->
                        <lightning-button-icon
                            icon-name="utility:close"
                            onclick={handleDropdown}
                            variant="bare"
                            alternative-text={labels.filterClosePopoverAltText}
                            class="slds-float_right slds-popover__close"
                            title={labels.filterClosePopoverAltText}
                        >
                        </lightning-button-icon>
                        <!-- popover body-->
                        <lightning-checkbox-group
                            name={labels.filterTitleText}
                            label={labels.filterTitleText}
                            options={options}
                            value={checkboxSelections}
                            onchange={handleFilterChange}
                        >
                        </lightning-checkbox-group>
                    </div>
                </section>
            </template>
        </div>
    </div>

    <div class="slds-panel__body slds-scrollable--y">
        <!--TODO move into seprate testPanel component-->
        <lightning-tabset if:true={showTestAssertions}>
            <lightning-tab label={labels.flowTestOutcomeTabLabel}>
                <lightning-accordion
                    allow-multiple-sections-open
                    class="slds-has-divider--bottom slds-p-around_none slds-m-around_none"
                    active-section-name={activeSectionsForTest}
                >
                    <template if:true={showTestAssertionLogs} for:each={testAssertionTrace} for:item="trace">
                        <builder_platform_interaction-accordion-section-with-icon
                            key={trace.id}
                            label={trace.assertionLabel}
                            name={trace.assertionLabel}
                            assertion-status={trace.status}
                            badge-properties={trace.testBadgeProperties}
                        >
                            <builder_platform_interaction-test-panel-body
                                test-assertion-trace={trace}
                            ></builder_platform_interaction-test-panel-body>
                        </builder_platform_interaction-accordion-section-with-icon>
                    </template>
                </lightning-accordion>
                <!-- error box if interview has error and there are no test assertions executed-->
                <template if:true={showAssertionsNotExecutedMsg}>
                    <div class="helptext slds-p-top_medium">
                        <div class="slds-box">
                            <div class="custom-builder-baseCallOutEditor__mode-info slds-grid">
                                <lightning-icon
                                    class="error"
                                    icon-name="utility:error"
                                    alternative-text="Info"
                                    variant="error"
                                    size="xx-small"
                                ></lightning-icon>
                                <p class="slds-text-color_weak withIcon sub-title slds-p-left_x-small">
                                    {labels.errorTitle}
                                </p>
                            </div>
                            <lightning-formatted-rich-text
                                class="test-assertion-empty-msg"
                                value={labels.assertionsNotExecuted}
                                disable-linkify="true"
                            ></lightning-formatted-rich-text>
                        </div>
                    </div>
                </template>
            </lightning-tab>
            <lightning-tab label={labels.flowTestLogTabLabel}>
                <!-- if there's an error, there will be no debugData.debugTraces-->
                <lightning-accordion
                    allow-multiple-sections-open
                    class="slds-has-divider--bottom slds-p-around_none slds-m-around_none"
                    active-section-name={activeSections}
                    onsectiontoggle={handleSectionToggle}
                >
                    <template for:each={debugTraces} for:item="trace">
                        <builder_platform_interaction-accordion-section-with-icon
                            data-name={trace.title}
                            key={trace.id}
                            label={trace.title}
                            name={trace.id}
                            element-icon={trace.elementIcon}
                        >
                            <builder_platform_interaction-debug-panel-body
                                lines={trace.lines}
                                error={trace.error}
                                title={trace.title}
                            ></builder_platform_interaction-debug-panel-body>
                        </builder_platform_interaction-accordion-section-with-icon>
                    </template>
                    <template if:true={showTestAssertionLogs} for:each={testAssertionTrace} for:item="trace">
                        <builder_platform_interaction-accordion-section-with-icon
                            key={trace.id}
                            label={trace.assertionLabel}
                            name={trace.assertionLabel}
                            assertion-status={trace.status}
                            badge-properties={trace.testBadgeProperties}
                        >
                            <builder_platform_interaction-test-panel-body
                                test-assertion-trace={trace}
                            ></builder_platform_interaction-test-panel-body>
                        </builder_platform_interaction-accordion-section-with-icon>
                    </template>
                </lightning-accordion>
            </lightning-tab>
        </lightning-tabset>

        <!--------------------------debug panel values --------------->
        <!--TODO duplication of code, move into seprate debugPanelAccordions component-->
        <!--debug panel values -->
        <lightning-accordion
            if:false={showTestAssertions}
            allow-multiple-sections-open
            class="slds-has-divider--bottom slds-p-around_none slds-m-around_none"
            active-section-name={activeSections}
            onsectiontoggle={handleSectionToggle}
        >
            <template for:each={debugTraces} for:item="trace">
                <builder_platform_interaction-accordion-section-with-icon
                    data-name={trace.title}
                    key={trace.id}
                    label={trace.title}
                    name={trace.title}
                    element-icon={trace.elementIcon}
                >
                    <builder_platform_interaction-debug-panel-body
                        lines={trace.lines}
                        error={trace.error}
                        title={trace.title}
                        waitevents={trace.waitevents}
                        resumetime={trace.resumetime}
                        limits={trace.limits}
                        ifblockresume={ifBlockResume}
                        show-gov-lim={showGovLim}
                    ></builder_platform_interaction-debug-panel-body>
                </builder_platform_interaction-accordion-section-with-icon>
            </template>
        </lightning-accordion>

        <!-- Error block For Debug and Test Panel-->
        <div if:true={hasErrors} class="error">
            <lightning-formatted-rich-text value={errorMessage} class="errorMsg"></lightning-formatted-rich-text>
        </div>
    </div>
</template>
